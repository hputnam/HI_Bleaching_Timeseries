---
title: "mixedmodels"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# load packages
library(lme4)
library(ggplot2)
library(MuMIn)
library(car)
library(lmerTest)
library(emmeans)
library(multcomp)
library(lattice)
library(effects)
library(sjPlot)
library(nlme)
```

# Import and format data
```{r}
rm(list = ls())

Master <- read.csv("data/PhysData.csv")
Master$ColonyID <- as.factor(Master$ColonyID)
Master$Date <- as.Date(Master$Date, format = "%m/%d/%y")
bleachseries <- subset(Master, Date >= "2019-09-16" & Date <= "2019-10-30")

set.seed(3593)
```

# All 2019 data
```{r}
Master <- subset(Master, Date < "2020-02-01")
```

## Bleaching score
```{r}
allscores <- Master[complete.cases(Master$BleachScore),]
ggplot(allscores, aes(x = Date, y = BleachScore, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
mcapallscores <- subset(allscores, Species == "Montipora capitata")
mcapallscores$Date <- as.factor(mcapallscores$Date)
mcap.bleach.all <- lmer(BleachScore ~ Bleach * Date + (1|ColonyID), data = mcapallscores)
summary(mcap.bleach.all)
anova(mcap.bleach.all, type = 3) # satterthwaite type iii
Anova(mcap.bleach.all, type = 3) # wald chisq type iii
qqPlot(residuals(mcap.bleach.all)) # normality of residuals
cld(emmeans(mcap.bleach.all, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

mcap.bleach.all.2 <- lmer(log10(BleachScore) ~ Bleach * Date + (1|ColonyID), data = mcapallscores)
anova(mcap.bleach.all.2, type = 3)
Anova(mcap.bleach.all.2, type = 3)
qqPlot(residuals(mcap.bleach.all.2))

model.sel(mcap.bleach.all, mcap.bleach.all.2) # log10 transform best fit uner AIC but no change to sig

# PCOM
pcomallscores <- subset(allscores, Species == "Porites compressa")
pcomallscores$Date <- as.factor(pcomallscores$Date)
pcom.bleach.all <- lmer(BleachScore ~ Bleach * Date + (1|ColonyID), data = pcomallscores)
summary(pcom.bleach.all)
anova(pcom.bleach.all, type = 3)
Anova(pcom.bleach.all, type = 3)
qqPlot(residuals(pcom.bleach.all)) 
cld(emmeans(pcom.bleach.all, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

pcom.bleach.all.2 <- lmer(log10(BleachScore) ~ Bleach * Date + (1|ColonyID), data = pcomallscores)
anova(pcom.bleach.all.2, type = 3)
Anova(pcom.bleach.all.2, type = 3)
qqPlot(residuals(pcom.bleach.all.2))

pcom.bleach.all.3 <- lmer(sqrt(BleachScore) ~ Bleach * Date + (1|ColonyID), data = pcomallscores)
anova(pcom.bleach.all.3, type = 3)
Anova(pcom.bleach.all.3, type = 3)
qqPlot(residuals(pcom.bleach.all.3))

pcom.bleach.all.4 <- lmer(log(BleachScore) ~ Bleach * Date + (1|ColonyID), data = pcomallscores)
anova(pcom.bleach.all.4, type = 3)
Anova(pcom.bleach.all.4, type = 3)
qqPlot(residuals(pcom.bleach.all.4))

model.sel(pcom.bleach.all, pcom.bleach.all.2, pcom.bleach.all.3, pcom.bleach.all.4) # log10 transform best fit under AIC but no change to sig
```

# Timeseries
## PAM 
```{r}
pamseries <- bleachseries[complete.cases(bleachseries$Yield), ]
ggplot(pamseries, aes(x = Date, y = Yield, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
pammcap <- subset(pamseries, Species == "Montipora capitata")
pammcap$Date <- as.factor(pammcap$Date)
mcap.pam <- lmer(Yield ~ Bleach * Date + (1|ColonyID), data = pammcap)
summary(mcap.pam)
anova(mcap.pam, type = 3) 
Anova(mcap.pam, type = 3)
qqPlot(residuals(mcap.pam)) 
cld(emmeans(mcap.pam, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

mcap.pam.2 <- lmer(log10(Yield) ~ Bleach * Date + (1|ColonyID), data = pammcap)
anova(mcap.pam.2, type = 3) 
Anova(mcap.pam.2, type = 3)
qqPlot(residuals(mcap.pam.2))

mcap.pam.3 <- lmer(sqrt(Yield) ~ Bleach * Date + (1|ColonyID), data = pammcap)
anova(mcap.pam.3, type = 3) 
Anova(mcap.pam.3, type = 3)
qqPlot(residuals(mcap.pam.3))

mcap.pam.4 <- lmer(log(Yield) ~ Bleach * Date + (1|ColonyID), data = pammcap)
anova(mcap.pam.4, type = 3) 
Anova(mcap.pam.4, type = 3)
qqPlot(residuals(mcap.pam.4))

mcap.pam.5 <- lme(Yield ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = pammcap, na.action = na.exclude)
Anova(mcap.pam.5, type = 3)
qqPlot(residuals(mcap.pam.5))

model.sel(mcap.pam, mcap.pam.2, mcap.pam.3, mcap.pam.4, mcap.pam.5) # sqrt transform best fit under AIC but no change to sig

# PCOM
pampcom <- subset(pamseries, Species == "Porites compressa")
pampcom$Date <- as.factor(pampcom$Date)
pcom.pam <- lmer(Yield ~ Bleach * Date + (1|ColonyID), data = pampcom)
summary(pcom.pam)
anova(pcom.pam, type = 3) 
Anova(pcom.pam, type = 3)
qqPlot(residuals(pcom.pam)) 
cld(emmeans(pcom.pam, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

pcom.pam.2 <- lmer(log10(Yield) ~ Bleach * Date + (1|ColonyID), data = pampcom)
anova(pcom.pam.2, type = 3) 
Anova(pcom.pam.2, type = 3)
qqPlot(residuals(pcom.bleach.all.2))

# PCOM
pcom.pam.3 <- lme(Yield ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = pampcom, na.action = na.exclude)
Anova(pcom.pam.3, type = 3)

pcom.pam.4 <- lme(log10(Yield) ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = pampcom, na.action = na.exclude)
Anova(pcom.pam.4, type = 3)
```

## Gross photosynthesis
```{r}
gpseries <- bleachseries[complete.cases(bleachseries$GP.umolcm2hr), ]
ggplot(gpseries, aes(x = Date, y = GP.umolcm2hr, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
gpmcap <- subset(gpseries, Species == "Montipora capitata")
gpmcap$Date <- as.factor(gpmcap$Date)
mcap.gp <- lmer(GP.umolcm2hr ~ Bleach * Date + (1|ColonyID), data = gpmcap)
summary(mcap.gp)
anova(mcap.gp, type = 3) 
Anova(mcap.gp, type = 3)
qqPlot(residuals(mcap.gp))
cld(emmeans(mcap.gp, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

mcap.gp.2 <- lmer(log10(GP.umolcm2hr) ~ Bleach * Date + (1|ColonyID), data = gpmcap)
anova(mcap.gp.2, type = 3)
Anova(mcap.gp.2, type = 3)
qqPlot(residuals(mcap.gp.2))

# PCOM
gppcom <- subset(gpseries, Species == "Porites compressa")
gppcom$Date <- as.factor(gppcom$Date)
pcom.gp <- lmer(GP.umolcm2hr ~ Bleach * Date + (1|ColonyID), data = gppcom)
summary(pcom.gp)
anova(pcom.gp, type = 3) 
Anova(pcom.gp, type = 3)
qqPlot(residuals(pcom.gp))
cld(emmeans(pcom.gp, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

pcom.gp.2 <- lmer(log10(GP.umolcm2hr) ~ Bleach * Date + (1|ColonyID), data = gppcom)
anova(pcom.gp.2, type = 3)
Anova(pcom.gp.2, type = 3)
qqPlot(residuals(pcom.gp.2))

## weighted chi sq type 3
# MCAP
mcap.gp.3 <- lme(GP.umolcm2hr ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = gpmcap, na.action = na.exclude)
Anova(mcap.gp.3, type = 3)
mcap.gp.4 <- lme(log10(GP.umolcm2hr) ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = gpmcap, na.action = na.exclude)
Anova(mcap.gp.4, type = 3)

# PCOM
pcom.gp.3 <- lme(GP.umolcm2hr ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = gppcom, na.action = na.exclude)
Anova(pcom.gp.3, type = 3)
pcom.gp.4 <- lme(log10(GP.umolcm2hr) ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = gppcom, na.action = na.exclude)
Anova(pcom.gp.4, type = 3)
```

## Respiration
```{r}
Rseries <- bleachseries[complete.cases(bleachseries$R.umolcm2hr), ]
ggplot(Rseries, aes(x = Date, y = R.umolcm2hr, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
rmcap <- subset(Rseries, Species == "Montipora capitata")
rmcap$Date <- as.factor(rmcap$Date)
mcap.r <- lmer(R.umolcm2hr ~ Bleach * Date + (1|ColonyID), data = rmcap)
summary(mcap.r)
anova(mcap.r, type = 3) 
Anova(mcap.r, type = 3)
qqPlot(residuals(mcap.r))
cld(emmeans(mcap.r, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

mcap.r.2 <- lmer(log10(abs(R.umolcm2hr)) ~ Bleach * Date + (1|ColonyID), data = rmcap)
anova(mcap.r.2, type = 3) 
Anova(mcap.r.2, type = 3)
qqPlot(residuals(mcap.r.2))

# PCOM
rpcom <- subset(Rseries, Species == "Porites compressa")
rpcom$Date <- as.factor(rpcom$Date)
pcom.r <- lmer(R.umolcm2hr ~ Bleach * Date + (1|ColonyID), data = rpcom)
summary(pcom.r)
anova(pcom.r, type = 3) 
Anova(pcom.r, type = 3)
qqPlot(residuals(pcom.r))
cld(emmeans(pcom.r, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

pcom.r.2 <- lmer(log10(abs(R.umolcm2hr)) ~ Bleach * Date + (1|ColonyID), data = rpcom)
anova(pcom.r.2, type = 3) 
Anova(pcom.r.2, type = 3)
qqPlot(residuals(pcom.r.2))

## weighted chi sq type 3
# MCAP
mcap.r.3 <- lme(R.umolcm2hr ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = rmcap, na.action = na.exclude)
Anova(mcap.r.3, type = 3)
mcap.r.4 <- lme(log10(abs(R.umolcm2hr)) ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = rmcap, na.action = na.exclude)
Anova(mcap.r.3, type = 3)

# PCOM
pcom.r.3 <- lme(R.umolcm2hr ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = rpcom, na.action = na.exclude)
Anova(pcom.r.3, type = 3)
pcom.r.4 <- lme(log10(abs(R.umolcm2hr)) ~ Bleach * Date, random = ~1|ColonyID, weights = varIdent(form = ~1|Date * Bleach), data = rpcom, na.action = na.exclude)
Anova(pcom.r.3, type = 3)
```

## Symbiont density
```{r}
symseries <- bleachseries[complete.cases(bleachseries$SymSA.cellcm2), ]
ggplot(symseries, aes(x = Date, y = SymSA.cellcm2, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
symmcap <- subset(symseries, Species == "Montipora capitata")
symmcap$Date <- as.factor(symmcap$Date)
mcap.sym <- lmer(SymSA.cellcm2 ~ Bleach * Date + (1|ColonyID), data = symmcap)
summary(mcap.sym)
anova(mcap.sym, type = 3) 
qqPlot(residuals(mcap.sym))
cld(emmeans(mcap.sym, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

# PCOM
sympcom <- subset(symseries, Species == "Porites compressa")
sympcom$Date <- as.factor(sympcom$Date)
pcom.sym <- lmer(SymSA.cellcm2 ~ Bleach * Date + (1|ColonyID), data = sympcom)
summary(pcom.sym)
anova(pcom.sym, type = 3) 
qqPlot(residuals(pcom.sym))
cld(emmeans(pcom.sym, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))
```

## Chlorophyll content
```{r}
chlseries <- bleachseries[complete.cases(bleachseries$ChlSA.ugcm2), ]
ggplot(chlseries, aes(x = Date, y = ChlSA.ugcm2, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
chlmcap <- subset(chlseries, Species == "Montipora capitata")
chlmcap$Date <- as.factor(chlmcap$Date)
mcap.chl <- lmer(ChlSA.ugcm2 ~ Bleach * Date + (1|ColonyID), data = chlmcap)
summary(mcap.chl)
anova(mcap.chl, type = 3) 
qqPlot(residuals(mcap.chl))
cld(emmeans(mcap.chl, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

# PCOM
chlpcom <- subset(chlseries, Species == "Porites compressa")
chlpcom$Date <- as.factor(chlpcom$Date)
pcom.chl <- lmer(ChlSA.ugcm2 ~ Bleach * Date + (1|ColonyID), data = chlpcom)
summary(pcom.chl)
anova(pcom.chl, type = 3) 
qqPlot(residuals(pcom.chl))
cld(emmeans(pcom.chl, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))
```

## Protein content
```{r}
proseries <- bleachseries[complete.cases(bleachseries$ProtSA.mgcm2), ]
ggplot(proseries, aes(x = Date, y = ProtSA.mgcm2, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
promcap <- subset(proseries, Species == "Montipora capitata")
promcap$Date <- as.factor(promcap$Date)
mcap.pro <- lmer(ProtSA.mgcm2 ~ Bleach * Date + (1|ColonyID), data = promcap)
summary(mcap.pro)
anova(mcap.pro, type = 3) 
qqPlot(residuals(mcap.pro))
cld(emmeans(mcap.pro, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

# PCOM
propcom <- subset(proseries, Species == "Porites compressa")
propcom$Date <- as.factor(propcom$Date)
pcom.pro <- lmer(ProtSA.mgcm2 ~ Bleach * Date + (1|ColonyID), data = propcom)
summary(pcom.pro)
anova(pcom.pro, type = 3) 
qqPlot(residuals(pcom.pro))
cld(emmeans(pcom.pro, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))
```

## Antioxidant capacity
```{r}
tacseries <- bleachseries[complete.cases(bleachseries$TACProt.uMug), ]
ggplot(tacseries, aes(x = Date, y = TACProt.uMug, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
tacmcap <- subset(tacseries, Species == "Montipora capitata")
tacmcap$Date <- as.factor(tacmcap$Date)
mcap.tac <- lmer(TACProt.uMug ~ Bleach * Date + (1|ColonyID), data = tacmcap)
summary(mcap.tac)
anova(mcap.tac, type = 3) 
qqPlot(residuals(mcap.tac))
cld(emmeans(mcap.tac, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

# PCOM
tacpcom <- subset(tacseries, Species == "Porites compressa")
tacpcom$Date <- as.factor(tacpcom$Date)
pcom.tac <- lmer(TACProt.uMug ~ Bleach * Date + (1|ColonyID), data = tacpcom)
summary(pcom.tac)
anova(pcom.tac, type = 3) 
qqPlot(residuals(pcom.tac))
cld(emmeans(pcom.tac, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))
```

## Biomass
```{r}
bmseries <- bleachseries[complete.cases(bleachseries$BM.mgcm2), ]
ggplot(bmseries, aes(x = Date, y = BM.mgcm2, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
bmmcap <- subset(bmseries, Species == "Montipora capitata")
bmmcap$Date <- as.factor(bmmcap$Date)
mcap.bm <- lmer(BM.mgcm2 ~ Bleach * Date + (1|ColonyID), data = bmmcap)
summary(mcap.bm)
anova(mcap.bm, type = 3) 
qqPlot(residuals(mcap.bm))
cld(emmeans(mcap.bm, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

# PCOM
bmpcom <- subset(bmseries, Species == "Porites compressa")
bmpcom$Date <- as.factor(bmpcom$Date)
pcom.bm <- lmer(BM.mgcm2 ~ Bleach * Date + (1|ColonyID), data = bmpcom)
summary(pcom.bm)
anova(pcom.bm, type = 3) 
qqPlot(residuals(pcom.bm))
cld(emmeans(pcom.bm, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))
```

## Ash-free dry weight
```{r}
afdwseries <- bleachseries[complete.cases(bleachseries$AFDW.g), ]
ggplot(afdwseries, aes(x = Date, y = AFDW.g, color = Bleach)) +
  stat_summary(aes(group = Bleach), fun = mean, geom = "point") +
  stat_summary(aes(group = Bleach), fun = mean, geom = "line") +
  stat_summary(aes(group = Bleach), fun.data = mean_se, geom = "errorbar", width = 3) +
  facet_grid(. ~ Species)

# MCAP
afdwmcap <- subset(afdwseries, Species == "Montipora capitata")
afdwmcap$Date <- as.factor(afdwmcap$Date)
mcap.afdw <- lmer(AFDW.g ~ Bleach * Date + (1|ColonyID), data = afdwmcap)
summary(mcap.afdw)
anova(mcap.afdw, type = 3) 
qqPlot(residuals(mcap.bm))
cld(emmeans(mcap.bm, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))

# PCOM
afdwpcom <- subset(afdwseries, Species == "Porites compressa")
afdwpcom$Date <- as.factor(afdwpcom$Date)
pcom.afdw <- lmer(AFDW.g ~ Bleach * Date + (1|ColonyID), data = afdwpcom)
summary(pcom.afdw)
anova(pcom.afdw, type = 3) 
qqPlot(residuals(pcom.bm))
cld(emmeans(pcom.bm, ~ Bleach * Date, adjust = "tukey"), Letters = c(LETTERS))
```